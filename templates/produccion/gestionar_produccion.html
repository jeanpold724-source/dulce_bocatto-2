{% extends "base.html" %}
{% block content %}
<h3>Producción del Pedido #{{ pedido.id }} — Estado: {{ pedido.estado }}</h3>

<form method="post" class="mb-3">
  {% csrf_token %}
  <button name="accion" value="en_produccion" class="btn btn-warning" {% if pedido.estado != "CONFIRMADO" %}disabled{% endif %}>
    Pasar a EN_PRODUCCION
  </button>
  <button name="accion" value="listo_entrega" class="btn btn-success">
    Marcar LISTO_ENTREGA (requiere stock OK)
  </button>
  <a class="btn btn-secondary" href="{% url 'pedidos_para_produccion' %}">Volver</a>
</form>

<table class="table">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Sabor</th>
      <th>Cantidad</th>
      <th>Stock Insumos</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item, ok, checks in verificados %}
    <tr>
      <td>{{ item.producto.nombre }}</td>
      <td>{{ item.sabor.nombre }}</td>
      <td>{{ item.cantidad }}</td>
      <td>
        <ul class="mb-0 ps-3">
          {% for c in checks %}
            <li class="{% if c.faltante > 0 %}text-danger{% else %}text-success{% endif %}">
              {{ c.insumo }} ({{ c.um }}):
              requiere {{ c.necesario|floatformat:3 }},
              stock {{ c.stock_kardex|default:c.stock_db|floatformat:3 }},
              faltante {{ c.faltante|floatformat:3 }}
              {% if c.faltante <= 0 %}✔{% else %}❌{% endif %}
            </li>
          {% endfor %}
        </ul>
      </td>
      <td>
        <a class="btn btn-sm btn-outline-primary"
           href="{% url 'producir_item' pedido.id item.producto_id item.sabor_id %}">
           Descontar insumos de este ítem
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
